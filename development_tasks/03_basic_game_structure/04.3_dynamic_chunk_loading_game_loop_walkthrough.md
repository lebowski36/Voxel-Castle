# 04.3 Dynamic Chunk Loading: Game Loop Walkthrough and Diagnosis

## Purpose
This document walks through the Voxel Fortress game loop and dynamic chunk loading logic, step by step, to diagnose why only a single chunk is rendered at the world center, despite code intended for dynamic loading and rendering of chunks around the camera.

---

## 1. Application Entry Point
- **File:** `game/src/main.cpp`
- The program starts in `main()`, which creates a `Game` object and calls `game.initialize()` and then `game.run()`.

## 2. Game Initialization
- **File:** `game/src/core/game.cpp` (`Game::initialize()`)
- Initializes all core systems: window, ECS, world manager, world generator, texture atlas, mesh builder, mesh renderer, camera, etc.
- Sets the initial camera position.
- **Static chunk creation is removed.**
- Calls `worldManager_->updateDirtyMeshes()` to build meshes for any dirty segments (should be empty at start).

## 3. Main Game Loop
- **File:** `game/src/core/game.cpp` (`Game::run()`)
- Each frame:
    1. `processInput()` (handles input, updates camera movement flags, etc.)
    2. `update(deltaTime)`
    3. `render()`

## 4. Per-Frame Update Logic
- **File:** `game/src/core/game.cpp` (`Game::update()`)
- Delegates to `GameLogic::update()` (in `core/GameLogic.cpp`).
- Handles camera movement, ECS progression, window update, and manual voxel changes.
- **Mesh generation:**
    - Calls `worldManager_->enqueueDirtyMeshJobs()` and `worldManager_->processFinishedMeshJobs()` every frame.
- **Dynamic chunk loading:**
    - Calls `worldManager_->updateActiveChunks(cameraPos, loadRadius, *worldGenerator_)` every frame, with camera position and a load radius (e.g., 3).

## 5. Dynamic Chunk Loading Logic
- **File:** `engine/src/world/world_manager.cpp` (`WorldManager::updateActiveChunks()`)
- Converts camera world position to chunk column coordinates (using `ChunkSegment::CHUNK_WIDTH`/`CHUNK_DEPTH`).
- For each column in the load radius, calls `getOrCreateChunkColumn()` and for each segment in Y, calls `getOrCreateSegment()` and generates if needed.
- Unloads columns outside the active radius.

## 6. Mesh Generation and Upload
- **File:** `engine/src/world/world_manager.cpp`
- For all columns/segments, if dirty, enqueues mesh jobs and uploads finished meshes.
- Meshes are stored in each segment and collected by `getAllSegmentMeshes()`.

## 7. Rendering
- **File:** `game/src/core/GameRenderer.cpp`
- Renders all meshes returned by `worldManager_->getAllSegmentMeshes()`.
- Each mesh is drawn at its world position.

---

## Diagnosis: Why Only One Chunk Renders

- **All logic for dynamic loading and rendering is present and called every frame.**
- The chunk loading logic in `updateActiveChunks` uses chunk column coordinates, and mesh generation is triggered for all dirty segments.
- **However, only one chunk is rendered at the world center.**

### Possible Causes
1. **Camera Position/Load Radius:** If the camera never leaves the initial chunk column, only that column is loaded. If the load radius is too small, only one column is ever active.
2. **Coordinate Conversion Bug:** If the conversion from world position to chunk column coordinates is incorrect, the same column may be loaded repeatedly.
3. **Mesh Generation/Upload:** If only one segment is ever marked dirty or meshed, only one mesh will be rendered.
4. **Premature Unloading:** If columns are unloaded too aggressively, only the center column remains.

### Next Steps
- **Log the camera position and the set of loaded chunk columns every frame.**
- **Log the coordinates of all meshes being rendered.**
- **Check if the camera is actually moving far enough to cross chunk column boundaries.**
- **Check if the load radius is sufficient (should be at least 2-3 to see multiple columns).**
- **Check if the coordinate conversion in `updateActiveChunks` matches the logic in `getOrCreateChunkColumn` and mesh generation.**

---

## Action Items
- Add debug logging to print:
    - Camera world position and calculated chunk column coordinates.
    - List of all loaded chunk columns each frame.
    - List of all mesh world positions each frame.
- Move the camera far from the origin and observe if new columns are loaded and rendered.
- Adjust the load radius and verify if more columns appear.
- If only one column is ever loaded, focus on coordinate conversion and unloading logic.

---

## Summary
- The game loop and dynamic chunk loading logic are correctly structured and called every frame.
- The most likely cause is a coordinate conversion or radius issue, or overly aggressive unloading.
- Debug logging and camera movement tests are the next step to pinpoint the issue.
